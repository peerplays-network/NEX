stages:
  - build_base
  # - build_test
  # - test

variables:
  CYPRESS_BROWSER_TAG: node16.14.0-chrome99-ff97
  CYPRESS_IMAGE: cypress/browsers:${CYPRESS_BROWSER_TAG}

build_base_cypress:
  stage: build_base
  image: docker:19.03.12
  services:
    - docker:19.03.12-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  variables:
  script:
    # - echo $SHELL
    # - echo $BASH_VERSION
    - PACKAGES_SHA1=$(cat package*.json | sha1sum | awk '{print $1}')
    - BASE_IMAGE=$CYPRESS_IMAGE
    - FINAL_TAG=cypress-${CYPRESS_BROWSER_TAG}-packages-${PACKAGES_SHA1}

    - echo $PACKAGES_SHA1
    - echo $FINAL_TAG

    - REGISTRY_FINAL_IMAGE=$CI_REGISTRY_IMAGE:$FINAL_TAG
    - echo $REGISTRY_FINAL_IMAGE

    - docker manifest inspect $REGISTRY_FINAL_IMAGE ; echo $?

    #
    # instead of pulling base image, just check if its there, if it is, dont pull and build and push
    #
    - docker pull $REGISTRY_FINAL_IMAGE || true
    - docker build -f Dockerfile.base --build-arg BASE_IMAGE=$BASE_IMAGE --cache-from $REGISTRY_FINAL_IMAGE -t $REGISTRY_FINAL_IMAGE .
    - docker push $REGISTRY_FINAL_IMAGE

#     - docker build -f Dockerfile.cypress --cache-from $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA



    # Dockerfile.cypress-node16.14.0-chrome99-ff97
    # tag it as cypress-node16.14.0-chrome99-ff97-PACKAGES-SHA1SUM
    # this way everything ignores the branch
    #
    - pwd
    - ls -alF
    # - docker info


# cypress_build:
#   stage: build_test
#   image: docker:19.03.12
#   services:
#     - docker:19.03.12-dind
#   before_script:
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#   variables:
#   script:

#     # Dockerfile.cypress-node16.14.0-chrome99-ff97
#     # tag it as cypress-node16.14.0-chrome99-ff97-PACKAGES-SHA1SUM
#     # this way everything ignores the branch
#     #
#     - pwd
#     - ls -alF
#     - docker info
#     - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG || true
#     - docker build -f Dockerfile.cypress --cache-from $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

# cypress_test_chrome:
#   stage: test
#   image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#   variables:
#     GIT_STRATEGY: none
#   script:
#     - pwd && ls -alF && cd /app && ls -alF
#     - ./node_modules/.bin/cypress run --browser chrome

# cypress_test_firefox:
#   stage: test
#   image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#   variables:
#     GIT_STRATEGY: none
#   script:
#     - pwd && ls -alF && cd /app && ls -alF
#     - ./node_modules/.bin/cypress run --browser firefox

# cypress_test_electron:
#   stage: test
#   image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#   variables:
#     GIT_STRATEGY: none
#   script:
#     - pwd && ls -alF && cd /app && ls -alF
#     - ./node_modules/.bin/cypress run --browser electron


# need artifacts with expiry

# sha1 on both package files, tag as combined sha1

# run again ###